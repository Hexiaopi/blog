(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{606:function(s,t,a){s.exports=a.p+"assets/img/MySQL-Read-Simple.b44f0ff6.png"},685:function(s,t,a){s.exports=a.p+"assets/img/MySQL-Read-Process.89c5c0cd.png"},686:function(s,t,a){s.exports=a.p+"assets/img/MySQL-AST.b707d03e.png"},755:function(s,t,a){"use strict";a.r(t);var r=a(11),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,r=s._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("p",[r("img",{attrs:{src:"https://cdn.cjhe.top/blog/MySQL-Read-Simple.png",alt:"read"}})]),s._v(" "),r("h2",{attrs:{id:"执行流程"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#执行流程"}},[s._v("#")]),s._v(" 执行流程")]),s._v(" "),r("p",[s._v("简单的查询过程如下：")]),s._v(" "),r("p",[r("img",{attrs:{src:a(606),alt:"MySQL交互流程"}})]),s._v(" "),r("p",[s._v("详细的查询过程如下：")]),s._v(" "),r("p",[r("img",{attrs:{src:a(685),alt:"MySQL查询流程"}})]),s._v(" "),r("h3",{attrs:{id:"连接器"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#连接器"}},[s._v("#")]),s._v(" 连接器")]),s._v(" "),r("blockquote",[r("p",[s._v("连接器负责跟客户端建立连接、获取权限、维持和管理连接。")])]),s._v(" "),r("p",[s._v("我们使用以下命令和MySQL建立连接")]),s._v(" "),r("div",{staticClass:"language-shell line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[s._v("mysql -h"),r("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),s._v(" -p"),r("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v(" -u"),r("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$user")]),s._v(" -P\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br")])]),r("ul",[r("li",[s._v("如果用户名或密码不对，就会收到一个"),r("code",[s._v("Access denied for user")]),s._v("的错误")]),s._v(" "),r("li",[s._v("如果用户名密码认证通过，连接器会到权限表里查出当前用户的权限。")])]),s._v(" "),r("p",[s._v("我们使用"),r("code",[s._v("show processlist")]),s._v("命令可以查看当前建立的连接以及执行的动作")]),s._v(" "),r("div",{staticClass:"language-shell line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[s._v("mysql"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" show processlist"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n+----+-----------------+-----------+------+---------+---------+------------------------+------------------+\n"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Id "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" User            "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Host      "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" db   "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Command "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Time    "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" State                  "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Info             "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+----+-----------------+-----------+------+---------+---------+------------------------+------------------+\n"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" event_scheduler "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" localhost "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" NULL "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Daemon  "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2486885")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Waiting on empty queue "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" NULL             "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" root            "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" localhost "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" NULL "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Query   "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" starting               "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" show processlist "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+----+-----------------+-----------+------+---------+---------+------------------------+------------------+\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" rows "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.07")]),s._v(" sec"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br"),r("span",{staticClass:"line-number"},[s._v("4")]),r("br"),r("span",{staticClass:"line-number"},[s._v("5")]),r("br"),r("span",{staticClass:"line-number"},[s._v("6")]),r("br"),r("span",{staticClass:"line-number"},[s._v("7")]),r("br"),r("span",{staticClass:"line-number"},[s._v("8")]),r("br")])]),r("h3",{attrs:{id:"查询缓存"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#查询缓存"}},[s._v("#")]),s._v(" 查询缓存")]),s._v(" "),r("blockquote",[r("p",[r("code",[s._v("<=MySQL5.7版本")]),s._v("，自带缓存模块，默认关闭；")]),s._v(" "),r("p",[r("code",[s._v(">=MySQL5.8版本")]),s._v("，移除缓存模块")])]),s._v(" "),r("p",[s._v("MySQL拿到一个查询请求后，会先进行缓存查询，如果之前执行的语句有缓存，则直接返回；")]),s._v(" "),r("p",[s._v("缓存的限制：")]),s._v(" "),r("ul",[r("li",[s._v("sql语句完全一致")]),s._v(" "),r("li",[s._v("表里的数据不发生变化，如果发生变化，这张表的所有缓存都会失效")])]),s._v(" "),r("p",[s._v("因此，"),r("strong",[s._v("不建议使用查询缓存")]),s._v("！")]),s._v(" "),r("h3",{attrs:{id:"分析器"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#分析器"}},[s._v("#")]),s._v(" 分析器")]),s._v(" "),r("blockquote",[r("p",[s._v("分析器对SQL语句进行词法分析、语法分析、语义检查，得到语法树，在这个阶段，输入的是一条SQL语句，输出的是一棵语法树（AST）。")])]),s._v(" "),r("ul",[r("li",[r("p",[r("strong",[s._v("词法分析")]),s._v("：从左到右一个字符、一个字符的读入源输入，根据构词规则识别出一条SQL语句里面的字符串分别是什么，代表什么。")])]),s._v(" "),r("li",[r("p",[r("strong",[s._v("语法分析")]),s._v("：在词法分析的基础上将单词序列组合成各类语法短语，如：“程序”、“语句”、“表达式”等。判断输入的这个SQL语句是否满足MySQL语法。如果语句不对，就会收到"),r("code",[s._v("You have an error in your SQL syntax")]),s._v("的错误提醒。")])]),s._v(" "),r("li",[r("p",[r("strong",[s._v("语义检查")]),s._v("：对语法分析树进行逻辑判断，例如：")]),s._v(" "),r("ul",[r("li",[s._v("检查表名是否错误（存在）")]),s._v(" "),r("li",[s._v("检查列名是否错误（存在）")]),s._v(" "),r("li",[s._v("检查别名是否错误（保证没有歧义）")])])])]),s._v(" "),r("p",[s._v("例如：")]),s._v(" "),r("div",{staticClass:"language-sql line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" id"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" name "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" t_user "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ACTIVE'")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" age "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v("\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br")])]),r("p",[s._v("解析为语法树如下：\n"),r("img",{attrs:{src:a(686),alt:"ast"}})]),s._v(" "),r("p",[r("a",{attrs:{href:"https://shardingsphere.apache.org/document/current/cn/reference/sharding/parse/",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考链接"),r("OutboundLink")],1)]),s._v(" "),r("h3",{attrs:{id:"优化器"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#优化器"}},[s._v("#")]),s._v(" 优化器")]),s._v(" "),r("p",[s._v("经过分析器，MySQL知道你需要做什么，在开始执行之前，还需要经过优化器的处理。")]),s._v(" "),r("p",[s._v("例如：优化器在表里面有多个索引的时候，决定使用哪个索引，或者在一个语句有多表关联(join)的时候，决定各个表的连接顺序。")]),s._v(" "),r("div",{staticClass:"language-sql line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-sql"}},[r("code",[r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" t1 "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" t2 "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("using")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ID"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" t1"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" t2"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("d"),r("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br")])]),r("ul",[r("li",[s._v("即可以先从表t1里面取出c=10的记录，再根据ID关联到表t2，再判断t2里面的d的值是否等于20")]),s._v(" "),r("li",[s._v("也可以先从表t2里面取出d=20的记录，再根据ID关联到表t1，再判断t1里面的c的值是否等于10")])]),s._v(" "),r("p",[s._v("这两种执行方案的逻辑一致，但是执行的效率会有不同，优化器会决定选择使用哪一个方案。")]),s._v(" "),r("h4",{attrs:{id:"逻辑优化"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#逻辑优化"}},[s._v("#")]),s._v(" 逻辑优化")]),s._v(" "),r("blockquote",[r("p",[s._v("优化器在逻辑优化阶段主要解决的问题是：如何找出SQL语句等价的变换形式，使得SQL执行更高效。")])]),s._v(" "),r("h4",{attrs:{id:"物理优化"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#物理优化"}},[s._v("#")]),s._v(" 物理优化")]),s._v(" "),r("blockquote",[r("p",[s._v("根据数据库的状态统计信息（数据库通过采样，统计出来的表、索引的相关信息，例如：表的记录数、索引的page数量、字段的Cardinality）计算各种操作算法的执行代价，定量的选择最优的查询方式。")])]),s._v(" "),r("h3",{attrs:{id:"执行器"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#执行器"}},[s._v("#")]),s._v(" 执行器")]),s._v(" "),r("blockquote",[r("p",[s._v("MySQL通过分析器知道了要做什么，通过优化器知道了该怎么做，就会进入执行器阶段，开始执行语句")])]),s._v(" "),r("p",[s._v("开始之前，先判断一下用户对表有没有查询的权限，如果没有就会返回没有权限错误，如果有权限，就打开表继续执行，执行器根据表的引擎定义，去使用这个引擎提供的接口。")])])}),[],!1,null,null,null);t.default=e.exports}}]);